<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.126.3"><meta name=generator content="Relearn 6.0.0+tip"><meta name=description content="This guide will walk you through the process of taking an existing non-trivial application and getting it CRaC-able. The workshop describes the application, please refer there for any details. We’ll start right away with the result of that workshop:
Make sure that JAVA_HOME points to OpenJDK CRaC JDK, and ensure that CRaC works (CRIU has correct permissions etc). Checkout and build Super Heroes: git clone https://github.com/quarkusio/quarkus-workshops cd quarkus-workshops/quarkus-workshop-super-heroes ./mvnw clean package -DskipTests -Pcomplete Run the infrastructure: docker-compose -f super-heroes/infrastructure/docker-compose."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Quarkus Super Heroes :: crac.org"><meta name=twitter:description content="This guide will walk you through the process of taking an existing non-trivial application and getting it CRaC-able. The workshop describes the application, please refer there for any details. We’ll start right away with the result of that workshop:
Make sure that JAVA_HOME points to OpenJDK CRaC JDK, and ensure that CRaC works (CRIU has correct permissions etc). Checkout and build Super Heroes: git clone https://github.com/quarkusio/quarkus-workshops cd quarkus-workshops/quarkus-workshop-super-heroes ./mvnw clean package -DskipTests -Pcomplete Run the infrastructure: docker-compose -f super-heroes/infrastructure/docker-compose."><meta property="og:url" content="https://crac.org/examples/super-heroes/index.html"><meta property="og:site_name" content="crac.org"><meta property="og:title" content="Quarkus Super Heroes :: crac.org"><meta property="og:description" content="This guide will walk you through the process of taking an existing non-trivial application and getting it CRaC-able. The workshop describes the application, please refer there for any details. We’ll start right away with the result of that workshop:
Make sure that JAVA_HOME points to OpenJDK CRaC JDK, and ensure that CRaC works (CRIU has correct permissions etc). Checkout and build Super Heroes: git clone https://github.com/quarkusio/quarkus-workshops cd quarkus-workshops/quarkus-workshop-super-heroes ./mvnw clean package -DskipTests -Pcomplete Run the infrastructure: docker-compose -f super-heroes/infrastructure/docker-compose."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="Example implementations"><meta itemprop=name content="Quarkus Super Heroes :: crac.org"><meta itemprop=description content="This guide will walk you through the process of taking an existing non-trivial application and getting it CRaC-able. The workshop describes the application, please refer there for any details. We’ll start right away with the result of that workshop:
Make sure that JAVA_HOME points to OpenJDK CRaC JDK, and ensure that CRaC works (CRIU has correct permissions etc). Checkout and build Super Heroes: git clone https://github.com/quarkusio/quarkus-workshops cd quarkus-workshops/quarkus-workshop-super-heroes ./mvnw clean package -DskipTests -Pcomplete Run the infrastructure: docker-compose -f super-heroes/infrastructure/docker-compose."><meta itemprop=wordCount content="950"><title>Quarkus Super Heroes :: crac.org</title>
<link href=/css/fontawesome-all.min.css?1717570297 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css?1717570297 rel=stylesheet></noscript><link href=/css/nucleus.css?1717570297 rel=stylesheet><link href=/css/auto-complete.css?1717570297 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/auto-complete.css?1717570297 rel=stylesheet></noscript><link href=/css/perfect-scrollbar.min.css?1717570297 rel=stylesheet><link href=/css/fonts.css?1717570297 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css?1717570297 rel=stylesheet></noscript><link href=/css/theme.css?1717570297 rel=stylesheet><link href=/css/theme-blue.css?1717570297 rel=stylesheet id=R-variant-style><link href=/css/chroma-learn.css?1717570297 rel=stylesheet id=R-variant-chroma-style><link href=/css/variant.css?1717570297 rel=stylesheet><link href=/css/print.css?1717570297 rel=stylesheet media=print><script src=/js/variant.js?1717570297></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="https://crac.org",window.variants&&variants.init(["blue"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script></head><body class="mobile-support html" data-url=/examples/super-heroes/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#replacing-crac-non-compatible-artifacts>Replacing CRaC non-compatible artifacts</a></li><li><a href=#runnning-the-patched-version>Runnning the patched version</a></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/index.html><span itemprop=name>Coordinated Restore at Checkpoint</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/examples/index.html><span itemprop=name>Example implementations</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Quarkus Super Heroes</span><meta itemprop=position content="3"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/examples/jetty/index.html title="Jetty (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/frameworks/index.html title="Frameworks with CRaC integration (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=quarkus-super-heroes>Quarkus Super Heroes</h1><p>This guide will walk you through the process of taking an existing non-trivial application and getting it CRaC-able. The <a href=https://quarkus.io/quarkus-workshops/super-heroes/spine.html rel=external target=_blank>workshop</a> describes the application, please refer there for any details. We&rsquo;ll start right away with the result of that workshop:</p><ol><li>Make sure that JAVA_HOME points to OpenJDK CRaC JDK, and ensure that CRaC works (CRIU has correct permissions etc).</li><li>Checkout and build Super Heroes:</li></ol><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone https://github.com/quarkusio/quarkus-workshops
</span></span><span style=display:flex><span>cd quarkus-workshops/quarkus-workshop-super-heroes
</span></span><span style=display:flex><span>./mvnw clean package -DskipTests -Pcomplete</span></span></code></pre></div><ol start=3><li>Run the infrastructure:</li></ol><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker-compose -f super-heroes/infrastructure/docker-compose.yaml up -d</span></span></code></pre></div><ol start=4><li>Start the UI</li></ol><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$JAVA_HOME/bin/java -jar super-heroes/ui-super-heroes/target/quarkus-app/quarkus-run.jar</span></span></code></pre></div><ol start=5><li>In individual consoles start the microservices</li></ol><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$JAVA_HOME/bin/java -XX:CRaCCheckpointTo<span style=color:#f92672>=</span>/tmp/heroes -jar super-heroes/rest-heroes/target/quarkus-app/quarkus-run.jar 
</span></span><span style=display:flex><span>$JAVA_HOME/bin/java -XX:CRaCCheckpointTo<span style=color:#f92672>=</span>/tmp/villains -jar super-heroes/rest-villains/target/quarkus-app/quarkus-run.jar
</span></span><span style=display:flex><span>$JAVA_HOME/bin/java -XX:CRaCCheckpointTo<span style=color:#f92672>=</span>/tmp/fights <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -Dquarkus.http.cors.origins<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;*&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -Dcom.arjuna.ats.internal.arjuna.utils.processImplementation<span style=color:#f92672>=</span>com.arjuna.ats.internal.arjuna.utils.UuidProcessId <span style=color:#ae81ff>\ </span>
</span></span><span style=display:flex><span>  -jar super-heroes/rest-fights/target/quarkus-app/quarkus-run.jar</span></span></code></pre></div><p>Note that the property selecting Arjuna&rsquo;s <code>processImplementation</code> is not necessary at this point; we&rsquo;ll need that later, though.</p><ol start=6><li>Open http://localhost:8080, click on &lsquo;New fighters&rsquo; and &lsquo;Fight&rsquo; a few times.</li></ol><p>It seems that there is a bug in the original application: the first request usually fails due to a timeout. This is unrelated to CRaC, and since subsequent requests usually succeed we can just reload the site (Ctrl+F5 in most browsers) and see that the application works correctly.</p><ol start=7><li>Checkpoint the three microservices:</li></ol><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#66d9ef>for</span> pid in <span style=color:#66d9ef>$(</span>jps -l | grep super-heroes/rest- | cut -f <span style=color:#ae81ff>1</span> -d <span style=color:#e6db74>&#39; &#39;</span><span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span> jcmd $pid JDK.checkpoint; <span style=color:#66d9ef>done</span>;</span></span></code></pre></div><p>CRaC will experience some problems due to files or network connection being open:</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>1586473:
</span></span><span style=display:flex><span>An exception during a checkpoint operation:
</span></span><span style=display:flex><span>jdk.crac.CheckpointException
</span></span><span style=display:flex><span>	at java.base/jdk.crac.Core.checkpointRestore1<span style=color:#f92672>(</span>Core.java:182<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	at java.base/jdk.crac.Core.checkpointRestore<span style=color:#f92672>(</span>Core.java:287<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	at java.base/jdk.crac.Core.checkpointRestoreInternal<span style=color:#f92672>(</span>Core.java:303<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	Suppressed: jdk.crac.impl.CheckpointOpenSocketException: tcp6 localAddr ::ffff:127.0.0.1 localPort <span style=color:#ae81ff>48768</span> remoteAddr ::ffff:127.0.0.1 remotePort <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.translateJVMExceptions<span style=color:#f92672>(</span>Core.java:120<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.checkpointRestore1<span style=color:#f92672>(</span>Core.java:186<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		... <span style=color:#ae81ff>2</span> more
</span></span><span style=display:flex><span>1586666:
</span></span><span style=display:flex><span>CR: Checkpoint ...
</span></span><span style=display:flex><span>1586548:
</span></span><span style=display:flex><span>An exception during a checkpoint operation:
</span></span><span style=display:flex><span>jdk.crac.CheckpointException
</span></span><span style=display:flex><span>	at java.base/jdk.crac.Core.checkpointRestore1<span style=color:#f92672>(</span>Core.java:122<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	at java.base/jdk.crac.Core.checkpointRestore<span style=color:#f92672>(</span>Core.java:246<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	at java.base/jdk.crac.Core.checkpointRestoreInternal<span style=color:#f92672>(</span>Core.java:262<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	Suppressed: java.nio.channels.IllegalSelectorException
</span></span><span style=display:flex><span>		at java.base/sun.nio.ch.EPollSelectorImpl.beforeCheckpoint<span style=color:#f92672>(</span>EPollSelectorImpl.java:384<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.impl.AbstractContextImpl.beforeCheckpoint<span style=color:#f92672>(</span>AbstractContextImpl.java:66<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.impl.AbstractContextImpl.beforeCheckpoint<span style=color:#f92672>(</span>AbstractContextImpl.java:66<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.checkpointRestore1<span style=color:#f92672>(</span>Core.java:120<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		... <span style=color:#ae81ff>2</span> more
</span></span><span style=display:flex><span>	Suppressed: jdk.crac.impl.CheckpointOpenSocketException: tcp6 localAddr ::ffff:127.0.0.1 localPort <span style=color:#ae81ff>51778</span> remoteAddr ::ffff:127.0.0.1 remotePort <span style=color:#ae81ff>9092</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.translateJVMExceptions<span style=color:#f92672>(</span>Core.java:91<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.checkpointRestore1<span style=color:#f92672>(</span>Core.java:145<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		... <span style=color:#ae81ff>2</span> more
</span></span><span style=display:flex><span>	Suppressed: jdk.crac.impl.CheckpointOpenSocketException: tcp6 localAddr ::ffff:127.0.0.1 localPort <span style=color:#ae81ff>52200</span> remoteAddr ::ffff:127.0.0.1 remotePort <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.translateJVMExceptions<span style=color:#f92672>(</span>Core.java:91<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.checkpointRestore1<span style=color:#f92672>(</span>Core.java:145<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		... <span style=color:#ae81ff>2</span> more
</span></span><span style=display:flex><span>	Suppressed: jdk.crac.impl.CheckpointOpenResourceException: anon_inode:<span style=color:#f92672>[</span>eventpoll<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.translateJVMExceptions<span style=color:#f92672>(</span>Core.java:97<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.checkpointRestore1<span style=color:#f92672>(</span>Core.java:145<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		... <span style=color:#ae81ff>2</span> more
</span></span><span style=display:flex><span>	Suppressed: jdk.crac.impl.CheckpointOpenResourceException: anon_inode:<span style=color:#f92672>[</span>eventfd<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.translateJVMExceptions<span style=color:#f92672>(</span>Core.java:97<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.checkpointRestore1<span style=color:#f92672>(</span>Core.java:145<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		... <span style=color:#ae81ff>2</span> more
</span></span><span style=display:flex><span>	Suppressed: jdk.crac.impl.CheckpointOpenSocketException: tcp6 localAddr ::ffff:127.0.0.1 localPort <span style=color:#ae81ff>58142</span> remoteAddr ::ffff:127.0.0.1 remotePort <span style=color:#ae81ff>9092</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.translateJVMExceptions<span style=color:#f92672>(</span>Core.java:91<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		at java.base/jdk.crac.Core.checkpointRestore1<span style=color:#f92672>(</span>Core.java:145<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		... <span style=color:#ae81ff>2</span> more</span></span></code></pre></div><p>In a framework like Quarkus it is not up to the application to handle this, framework should listen to CRaC notifications and close/reopen them. This guide won&rsquo;t describe how these problems can be identified and fixed, please see <a href=debugging.md>debugging guide</a> for that. Instead we will use version of dependencies that has these issues handled.</p><h2 id=replacing-crac-non-compatible-artifacts>Replacing CRaC non-compatible artifacts</h2><p>The vanilla version of Quarkus Super Heroes relies on artifacts that do not handle checkpoint
and this would fail due to open files or sockets. Until CRaC becomes mainstream and these
libraries handle notifications we provide a CRaC-ed version with some of the problems fixed.</p><p>In order to identify these dependencies before running into errors we have created a Maven Enforcer
rule that can be included in the build and highlights the incompatible artifacts:</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;build&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;plugins&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;groupId&gt;</span>org.apache.maven.plugins<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;artifactId&gt;</span>maven-enforcer-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;version&gt;</span>3.3.0<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;dependencies&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;groupId&gt;</span>io.github.crac<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;artifactId&gt;</span>crac-enforcer-rule<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;version&gt;</span>1.0.0<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/dependencies&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&lt;goal&gt;</span>enforce<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;rules&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;cracDependencies</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/rules&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/plugins&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/build&gt;</span></span></span></code></pre></div><p>Now when you try to build the project, the enforcer will spit out errors, including suggestions
for a replacement artifact:</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span> Failed to execute goal org.apache.maven.plugins:maven-enforcer-plugin:3.3.0:enforce <span style=color:#f92672>(</span>default<span style=color:#f92672>)</span> on project rest-villains: 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span> Rule 0: io.github.crac.CracDependencies failed with message:
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span> io.quarkus.workshop.super-heroes:rest-villains:jar:1.0.0-SNAPSHOT
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>    io.quarkus:quarkus-resteasy-reactive:jar:2.15.3.Final
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>       io.quarkus.resteasy.reactive:resteasy-reactive-vertx:jar:2.15.3.Final
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>          io.vertx:vertx-web:jar:4.3.6
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>             io.vertx:vertx-web-common:jar:4.3.6
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>                io.vertx:vertx-core:jar:4.3.6 &lt;--- replace with io.github.crac.io.vertx:vertx-core:4.3.8.CRAC.0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>             io.vertx:vertx-auth-common:jar:4.3.6
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>                io.vertx:vertx-core:jar:4.3.6 &lt;--- replace with io.github.crac.io.vertx:vertx-core:4.3.8.CRAC.0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>             io.vertx:vertx-bridge-common:jar:4.3.6
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>                io.vertx:vertx-core:jar:4.3.6 &lt;--- replace with io.github.crac.io.vertx:vertx-core:4.3.8.CRAC.0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>             io.vertx:vertx-core:jar:4.3.6 &lt;--- replace with io.github.crac.io.vertx:vertx-core:4.3.8.CRAC.0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>          io.smallrye.reactive:smallrye-mutiny-vertx-core:jar:2.29.0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>             io.smallrye.reactive:smallrye-mutiny-vertx-runtime:jar:2.29.0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>                io.vertx:vertx-core:jar:4.3.6 &lt;--- replace with io.github.crac.io.vertx:vertx-core:4.3.8.CRAC.0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>             io.vertx:vertx-core:jar:4.3.6 &lt;--- replace with io.github.crac.io.vertx:vertx-core:4.3.8.CRAC.0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>       io.quarkus:quarkus-vertx-http:jar:2.15.3.Final
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>          io.smallrye.common:smallrye-common-vertx-context:jar:1.13.2
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>             io.vertx:vertx-core:jar:4.3.6 &lt;--- replace with io.github.crac.io.vertx:vertx-core:4.3.8.CRAC.0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>          io.smallrye.reactive:smallrye-mutiny-vertx-web:jar:2.29.0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>             io.smallrye.reactive:smallrye-mutiny-vertx-uri-template:jar:2.29.0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>                io.vertx:vertx-uri-template:jar:4.3.6
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>                   io.vertx:vertx-core:jar:4.3.6 &lt;--- replace with io.github.crac.io.vertx:vertx-core:4.3.8.CRAC.0
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>    io.quarkus:quarkus-hibernate-orm-panache:jar:2.15.3.Final
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>       io.quarkus:quarkus-hibernate-orm:jar:2.15.3.Final
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>          io.quarkus:quarkus-agroal:jar:2.15.3.Final
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>ERROR<span style=color:#f92672>]</span>             io.agroal:agroal-pool:jar:1.16 &lt;--- replace with io.github.crac.io.agroal:agroal-pool:1.18.CRAC.0</span></span></code></pre></div><p>The offending dependencies can be removed using <code>&lt;exclusions></code>, and CRaC&rsquo;ed dependencies should be added.
Usually these have <code>groupId</code> prefixed with <code>org.github.crac.</code>, <code>artifactId</code> is identical and version is suffixed
with <code>.CRAC.N</code> where <code>N</code> stands for counter of CRaC-related changes; these should be added on top of the original (tagged) version.</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>io.quarkus<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>quarkus-resteasy-reactive<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;exclusions&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;exclusion&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;groupId&gt;</span>io.vertx<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;artifactId&gt;</span>vertx-core<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/exclusion&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/exclusions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>io.github.crac.io.vertx<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>vertx-core<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;version&gt;</span>4.3.8.CRAC.0<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span></span></span></code></pre></div><p>It&rsquo;s likely that there won&rsquo;t be a CRaC&rsquo;ed version exactly matching the original version; please test
for any compatibility issues thoroughly.</p><p>To see the &lsquo;patched&rsquo; version please see <a href=https://github.com/rvansa/quarkus-workshops/tree/crac rel=external target=_blank>this fork</a>.
To use the Maven Enforcer conveniently we have added a parent module to the microservices and set up Maven Enforcer.</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git remote add rvansa https://github.com/rvansa/quarkus-workshops.git
</span></span><span style=display:flex><span>git fetch rvansa crac <span style=color:#f92672>&amp;&amp;</span> checkout rvansa/crac</span></span></code></pre></div><h2 id=runnning-the-patched-version>Runnning the patched version</h2><ol><li><p>Make sure that the non-patched version of the microservices is not running anymore, e.g. using Ctrl+C in console.</p></li><li><p>Rebuild the patched microservices using <code>./mvnw clean package -DskipTests -Pcomplete</code></p></li><li><p>Repeat steps 5 - 7 from the previous attempt, starting the apps, issuing a few requests through UI and performing the checkpoint.</p></li></ol><p>The checkpoint might fail for some services: In this scenario Quarkus loads some classes during checkpoint
(e.g. from finalizers or when closing connections), opening some files. This may happen after the code that
was supposed to close all cached open files has executed, and leads to checkpoint failure.
If this is the case please trigger checkpoint again; this time everything should be loaded and the checkpoint should succeed.</p><ol start=4><li>Restore the services in individual consoles:</li></ol><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$JAVA_HOME/bin/java -jar -XX:CRaCRestoreFrom<span style=color:#f92672>=</span>/tmp/heroes
</span></span><span style=display:flex><span>$JAVA_HOME/bin/java -jar -XX:CRaCRestoreFrom<span style=color:#f92672>=</span>/tmp/villains
</span></span><span style=display:flex><span>$JAVA_HOME/bin/java -jar -XX:CRaCRestoreFrom<span style=color:#f92672>=</span>/tmp/fights</span></span></code></pre></div><ol start=5><li>Go to http://localhost:8080 and try to click through the UI few times. You can check consoles to see that everything works.</li></ol><p>Side note: The Super Heroes workshop includes one more microservice, the <code>event-statistics</code>. This microservice hasn&rsquo;t been CRaC&rsquo;ed yet
as it requires some additional fixes in Kafka.</p><footer class=footline></footer></article></div></main></div><aside id=R-sidebar class=default-animation><div id=R-header-topbar class=default-animation></div><div id=R-header-wrapper class=default-animation><div id=R-header class=default-animation><h1>CRaC</h1></div><search><div class="searchbox default-animation"><i class="fas fa-search" title="Search (CTRL+ALT+f)"></i>
<label class=a11y-only for=R-search-by>Search</label>
<input data-search-input id=R-search-by name=search-by class=search-by type=search placeholder=Search...>
<button class=search-clear type=button data-search-clear title="Clear search"><i class="fas fa-times" title="Clear search"></i></button></div></search><script>var contentLangs=["en"]</script><script src=/js/auto-complete.js?1717570297 defer></script><script src=/js/lunr/lunr.min.js?1717570297 defer></script><script src=/js/lunr/lunr.stemmer.support.min.js?1717570297 defer></script><script src=/js/lunr/lunr.multi.min.js?1717570297 defer></script><script src=/js/lunr/lunr.en.min.js?1717570297 defer></script><script src=/js/search.js?1717570297 defer></script></div><div id=R-homelinks class="default-animation homelinks"><ul><li><a class=padding href=/index.html><i class="fa-fw fas fa-home"></i> Home</a></li></ul><hr class=padding></div><div id=R-content-wrapper class=highlightable><div id=R-topics><ul class="enlarge morespace collapsible-menu"><li data-nav-id=/about/index.html><a class=padding href=/about/index.html>About CRaC</a><ul id=R-subsections-c4a96bff5af2343412fa2fdfa0cfc6f6 class="morespace collapsible-menu"><li data-nav-id=/about/about-crac/index.html><a class=padding href=/about/about-crac/index.html>What is Coordinated Restore at Checkpoint?</a></li><li data-nav-id=/about/results/index.html><a class=padding href=/about/results/index.html>Startup Improvement Results</a></li><li data-nav-id=/about/jdk-project/index.html><a class=padding href=/about/jdk-project/index.html>OpenJDK CRaC Project</a></li></ul></li><li data-nav-id=/use/index.html><a class=padding href=/use/index.html>Using CRaC</a><ul id=R-subsections-299919ff4f215b0c92d1f4b60def5273 class="morespace collapsible-menu"><li data-nav-id=/use/implement-crac/index.html><a class=padding href=/use/implement-crac/index.html>Implementing CRaC in your Application</a></li><li data-nav-id=/use/crac-runtime/index.html><a class=padding href=/use/crac-runtime/index.html>Java Runtime with CRaC Support</a></li><li data-nav-id=/use/checkpoint-and-restore/index.html><a class=padding href=/use/checkpoint-and-restore/index.html>Creating a Checkpoint and Restoring from Checkpoint</a></li></ul></li><li data-nav-id=/examples/index.html class=parent><a class=padding href=/examples/index.html>Example implementations</a><ul id=R-subsections-09293e995b11754c4445aab5dfe0a859 class="morespace collapsible-menu"><li data-nav-id=/examples/jetty/index.html><a class=padding href=/examples/jetty/index.html>Jetty</a></li><li data-nav-id=/examples/super-heroes/index.html class=active><a class=padding href=/examples/super-heroes/index.html>Quarkus Super Heroes</a></li></ul></li><li data-nav-id=/frameworks/index.html><a class=padding href=/frameworks/index.html>Frameworks with CRaC integration</a><ul id=R-subsections-8a7f48c592022db704353f5d4f8a5f78 class="morespace collapsible-menu"><li data-nav-id=/frameworks/spring-boot/index.html><a class=padding href=/frameworks/spring-boot/index.html>SpringBoot</a></li><li data-nav-id=/frameworks/quarkus/index.html><a class=padding href=/frameworks/quarkus/index.html>Quarkus</a></li><li data-nav-id=/frameworks/micronaut/index.html><a class=padding href=/frameworks/micronaut/index.html>Micronaut</a></li><li data-nav-id=/frameworks/aws-lambda/index.html><a class=padding href=/frameworks/aws-lambda/index.html>AWS Lambda</a></li></ul></li><li data-nav-id=/extra-info/index.html><a class=padding href=/extra-info/index.html>Extra info about CRaC</a><ul id=R-subsections-be6e2074d30c7492aa45132e8facf754 class="morespace collapsible-menu"><li data-nav-id=/extra-info/best-practices/index.html><a class=padding href=/extra-info/best-practices/index.html>Best Practices</a></li><li data-nav-id=/extra-info/debugging/index.html><a class=padding href=/extra-info/debugging/index.html>Debugging</a></li><li data-nav-id=/extra-info/cpu-features/index.html><a class=padding href=/extra-info/cpu-features/index.html>CPU Features</a></li><li data-nav-id=/extra-info/fd-policies/index.html><a class=padding href=/extra-info/fd-policies/index.html>File descriptor policies</a></li></ul></li></ul></div><div id=R-shortcuts><div class="nav-title padding">More</div><ul class=space><li><a class=padding href=https://github.com/CRaC><i class='fab fa-github'></i> CRaC Repository</a></li><li><a class=padding href=https://openjdk.org/projects/crac/><i class='fab fa-java'></i> OpenJDK Project</a></li><li><a class=padding href=https://wiki.openjdk.org/display/crac><i class='fab fa-java'></i> OpenJDK Wiki</a></li><li><a class=padding href=https://foojay.io/today/category/crac/><i class='fab fa-java'></i> Foojay Blogs</a></li></ul></div><div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div><div id=R-menu-footer><hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"><div id=R-prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks"><ul><li id=R-select-language-container class=footerLangSwitch><div class="padding menu-control"><i class="fa-fw fas fa-language"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-language>Language</label>
<select id=R-select-language onchange="location=this.querySelector(this.value).dataset.url"><option id=R-select-language-en value=#R-select-language-en data-url=/examples/super-heroes/index.html lang=en-us selected></option></select></div><div class=clear></div></div></li><li id=R-select-variant-container class=footerVariantSwitch><div class="padding menu-control"><i class="fa-fw fas fa-paint-brush"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-variant>Theme</label>
<select id=R-select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=R-select-variant-blue value=blue selected>Blue</option></select></div><div class=clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><div class="padding menu-control"><i class="fa-fw fas fa-history"></i>
<span>&nbsp;</span><div class=control-style><button onclick=clearHistory()>Clear History</button></div><div class=clear></div></div></li></ul></div><div id=R-footer class="footerFooter showFooter"><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn title=love><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></div></aside><script src=/js/clipboard.min.js?1717570297 defer></script><script src=/js/perfect-scrollbar.min.js?1717570297 defer></script><script src=/js/theme.js?1717570297 defer></script></body></html>